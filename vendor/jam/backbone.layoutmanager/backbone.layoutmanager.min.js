(function(n){var q,g=n.Backbone,e=n._,m=n.$,r=g.View.prototype._configure,s=Array.prototype.push,l=Array.prototype.concat,t=Array.prototype.splice,f=g.View.extend({constructor:function(a){a=a||{};f.setupView(this,a);g.View.call(this,a)},insertView:function(a,b){return b?this.setView(a,b,!0):this.setView(a,!0)},insertViews:function(a){if(e.isArray(a))return this.setViews({"":a});e.each(a,function(b,c){a[c]=e.isArray(b)?b:[b]});return this.setViews(a)},getView:function(a,b){"function"!==typeof a&&"string"!==
typeof a&&(a=b);return this.getViews(a).first().value()},getViews:function(a){var b=e.chain(this.views).map(function(a){return e.isArray(a)?a:[a]},this).flatten().value();return"string"===typeof a?e.chain([this.views[a]]).flatten():"object"===typeof a?e.chain([e.where(b,a)]).flatten():e.chain("function"===typeof a?e.filter(b,a):b)},removeView:function(a){return this.getViews(a).each(function(a){a.remove()})},setView:function(a,b,c){var d,h,j,f=this;"string"!==typeof a&&(c=b,b=a,a="");this.views=this.views||
{};d=b.__manager__;h=this.views[a];if(!d)throw Error("Please set `View#manage` property with selector '"+a+"' to `true`.");j=b.getAllOptions();d.parent=f;d.selector=a;b.on("all",function(a){"beforeRender"!==a&&"afterRender"!==a&&f.trigger.apply(f,arguments)},b);if(!c)return d.hasRendered&&j.partial(f.$el,b.$el,f.__manager__,d),h&&e.each(l.call([],h),function(a){a.remove()}),this.views[a]=b;this.views[a]=l.call([],h||[],b);d.insert=!0;return b},setViews:function(a){e.each(a,function(a,c){if(e.isArray(a))return e.each(a,
function(a){this.insertView(c,a)},this);this.setView(c,a)},this);return this},render:function(){function a(){function a(){var b=d.afterRender;b&&b.call(c,c);c.trigger("afterRender",c)}var b;j&&(d.contains(j.el,c.el)||d.partial(j.$el,c.$el,p,h));c.delegateEvents();h.hasRendered=!0;(b=h.queue.shift())?b():delete h.queue;if(p&&p.queue)j.once("afterRender",a);else a();return g.resolveWith(c,[c])}function b(){var b=c.getAllOptions();c._render(f._viewRender,b).done(function(){if(!e.keys(c.views).length)return a();
var d=e.map(c.views,function(a){var b=e.isArray(a);return b&&a.length?e.reduce(a.slice(1),function(a,b){return a.then(function(){return b.render()})},a[0].render()):!b?a.render():a});b.when(d).done(a)})}var c=this,d=c.getAllOptions(),h=c.__manager__,j=h.parent,p=j&&j.__manager__,g=d.deferred();h.queue?s.call(h.queue,b):(h.queue=[],b(c,g));g.view=c;return g},remove:function(){f._removeView(this,!0);return this._remove.apply(this,arguments)},getAllOptions:function(){return e.extend({},this,f.prototype.options,
this.options)}},{_cache:{},_makeAsync:function(a,b){var c=a.deferred();c.async=function(){c._isAsync=!0;return b};return c},_viewRender:function(a,b){function c(c){c&&(l.noel?a.setElement(c,!1):b.html(a.$el,c));g.resolveWith(a,[a])}function d(a,d){var e,g=f._makeAsync(b,function(a){c(a)});f.cache(h,d);d&&(e=b.render.call(g,d,a));g._isAsync||c(e)}var h,j,g,l=a.__manager__;return{render:function(){var c=a.serialize||b.serialize,k=a.template||b.template;e.isFunction(c)&&(c=c.call(a));g=f._makeAsync(b,
function(a){d(c,a)});"string"===typeof k&&(h=b.prefix+k);if(j=f.cache(h))return d(c,j,h),g;"string"===typeof k?j=b.fetch.call(g,b.prefix+k):"function"===typeof k?j=k:null!=k&&(j=b.fetch.call(g,k));g._isAsync||d(c,j);return g}}},_removeViews:function(a,b){"boolean"===typeof a&&(b=a,a=this);(a||this).getViews().each(function(a){(a.__manager__.hasRendered||b)&&f._removeView(a,b)})},_removeView:function(a,b){var c,d=a.__manager__;if(!("boolean"===typeof a.keep?a.keep:a.options.keep)&&(!0===d.insert||
b))if(f.cleanViews(a),a._removeViews(!0),a.$el.remove(),d.parent){c=d.parent.views[d.selector];if(e.isArray(c))return e.each(e.clone(c),function(a,b){a&&a.__manager__===d&&t.call(c,b,1)});delete d.parent.views[d.selector]}},cache:function(a,b){if(a in this._cache&&null==b)return this._cache[a];if(null!=a&&null!=b)return this._cache[a]=b},cleanViews:function(a){e.each(l.call([],a),function(a){a.unbind();a.model instanceof g.Model&&a.model.off(null,null,a);a.collection instanceof g.Collection&&a.collection.off(null,
null,a);a.stopListening();e.result(a,"cleanup")})},configure:function(a){e.extend(f.prototype.options,a);a.manage&&(g.View.prototype.manage=!0);!1===a.el&&(g.View.prototype.el=!1)},setupView:function(a,b){e.each(l.call([],a),function(a){if(!a.__manager__){var d,h=f.prototype,j=e.pick(a,q);e.defaults(a,{views:{},__manager__:{},_removeViews:f._removeViews,_removeView:f._removeView},f.prototype);b=a.options=e.defaults(b||{},a.options,h.options);d=e.pick(b,l.call(["events"],e.values(b.events)));e.extend(a,
d);(j.render===f.prototype.render||j.render===g.View.prototype.render)&&delete j.render;e.extend(b,j);a._remove=g.View.prototype.remove;a._render=function(a,b){var c=b.beforeRender;this.__manager__.hasRendered&&this._removeViews();c&&c.call(this,this);this.trigger("beforeRender",this);return a(this,b).render()};a.render=f.prototype.render;a.remove!==h.remove&&(a._remove=a.remove,a.remove=h.remove);d=b.views||a.views;e.keys(d).length&&(a.views={},a.setViews(d));a.options.template?a.options.template=
b.template:a.template&&(b.template=a.template,delete a.template)}})}});g.Layout=f;f.VERSION="0.8.3";g.View.prototype._configure=function(a){var b,c;if("el"in a?!1===a.el:!1===this.el)b=!0;c=r.apply(this,arguments);(a.manage||this.manage)&&f.setupView(this);this.__manager__&&(this.__manager__.noel=b);return c};f.prototype.options={prefix:"",deferred:function(){return m.Deferred()},fetch:function(a){return e.template(m(a).html())},partial:function(a,b,c,d){d.selector&&(c.noel?(c=a.filter(d.selector),
a=c.length?c:a.find(d.selector)):a=a.find(d.selector));d.insert?this.insert(a,b):this.html(a,b)},html:function(a,b){a.html(b)},insert:function(a,b){a.append(b)},when:function(a){return m.when.apply(null,a)},render:function(a,b){return a(b)},contains:function(a,b){return m.contains(a,b)}};q=e.keys(f.prototype.options)})("object"===typeof global?global:this);
