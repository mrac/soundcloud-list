(function(a){"use strict";var b,c=a.Backbone,d=a._,e=a.$,f=c.View.prototype._configure;c.View.prototype.render;var h=Array.prototype.push,i=Array.prototype.concat,j=Array.prototype.splice,k=c.View.extend({constructor:function(a){a=a||{},k.setupView(this,a),c.View.call(this,a)},insertView:function(a,b){return b?this.setView(a,b,!0):this.setView(a,!0)},insertViews:function(a){return d.isArray(a)?this.setViews({"":a}):(d.each(a,function(b,c){a[c]=d.isArray(b)?b:[b]}),this.setViews(a))},getView:function(a){return this.getViews(a).first().value()},getViews:function(a){var b=d.chain(this.views).map(function(a){return d.isArray(a)?a:[a]},this).flatten().value();return"string"==typeof a?d.chain([this.views[a]]).flatten():d.chain("function"==typeof a?d.filter(b,a):b)},setView:function(a,b,c){var e,f,g,h=this;if("string"!=typeof a&&(c=b,b=a,a=""),this.views=this.views||{},e=b.__manager__,f=this.views[a],!e)throw Error("Please set `View#manage` property with selector '"+a+"' to `true`.");return g=b._options(),e.parent=h,e.selector=a,c?(this.views[a]=i.call([],f||[],b),e.append=!0,b):(e.hasRendered&&g.partial(h.el,e.selector,b.el,e.append),f&&d.each(i.call([],f),function(a){a.remove()}),this.views[a]=b)},setViews:function(a){return d.each(a,function(a,b){return d.isArray(a)?d.each(a,function(a){this.insertView(b,a)},this):(this.setView(b,a),void 0)},this),this},render:function(){function i(){function h(){var c=b.afterRender;c&&c.call(a,a),a.trigger("afterRender",a)}var d;return e&&(b.contains(e.el,a.el)||b.partial(e.el,c.selector,a.el,c.append)),a.delegateEvents(),g.resolveWith(a,[a]),c.hasRendered=!0,(d=c.queue.shift())?d():delete c.queue,f&&!f.hasRendered?e.on("afterRender",function(){e.off("afterRender",null,this),h()},a):(h(),void 0)}function j(){var b=a._options(),c=a.__manager__,e=c.parent;e&&e.__manager__,a._render(k._viewRender,b).done(function(){if(!d.keys(a.views).length)return i();var c=d.map(a.views,function(a){var c=d.isArray(a);return c&&a.length?a[0].render().pipe(function(){return b.when(d.map(a.slice(1),function(a){return a.render()}))}):c?a:a.render()});b.when(c).done(function(){i()})})}var a=this,b=a._options(),c=a.__manager__,e=c.parent,f=e&&e.__manager__,g=b.deferred();return c.queue?h.call(c.queue,function(){j()}):(c.queue=[],j(a,g)),g.view=a,g},remove:function(){return k._removeView(this,!0),this._remove.apply(this,arguments)},_options:function(){return d.extend({},this,k.prototype.options,this.options)}},{_cache:{},_makeAsync:function(a,b){var c=a.deferred();return c.async=function(){return c._isAsync=!0,b},c},_viewRender:function(a,b){function h(c){c&&b.html(a.el,c),f.resolveWith(a,[a])}function i(a,d){var e,f=k._makeAsync(b,function(a){h(a)});k.cache(c,d),d&&(e=b.render.call(f,d,a)),f._isAsync||h(e)}var c,e,f;return a.__manager__,{render:function(){var h=b.data||b.serialize,j=a.template||b.template;return d.isFunction(h)&&(h=h.call(a)),f=k._makeAsync(b,function(a){i(h,a)}),"string"==typeof j&&(c=b.prefix+j),(e=k.cache(c))?(i(h,e,c),f):("string"==typeof j?e=b.fetch.call(f,b.prefix+j):null!=j&&(e=b.fetch.call(f,j)),f._isAsync||i(h,e),f)}}},_removeViews:function(a,b){"boolean"==typeof a&&(b=a,a=this),a=a||this,a.getViews().each(function(a){(a.__manager__.hasRendered||b)&&k._removeView(a,b)})},_removeView:function(a,b){var c,e=a.__manager__,f="boolean"==typeof a.keep?a.keep:a.options.keep;if(!f&&(e.append===!0||b)){if(k.cleanViews(a),a._removeViews(!0),a.$el.remove(),!e.parent)return;if(c=e.parent.views[e.selector],d.isArray(c))return d.each(d.clone(c),function(a,b){a&&a.__manager__===e&&j.call(c,b,1)});delete e.parent.views[e.selector]}},cleanViews:function(a){d.each(i.call([],a),function(a){a.unbind(),a.model instanceof c.Model&&a.model.off(null,null,a),a.collection instanceof c.Collection&&a.collection.off(null,null,a),a.cleanup&&a.cleanup.call(a)})},cache:function(a,b){return a in this._cache?this._cache[a]:null!=a&&null!=b?this._cache[a]=b:void 0},configure:function(a){d.extend(k.prototype.options,a),a.manage&&(c.View.prototype.manage=!0)},setupView:function(a,e){if(!a.__manager__){var f,g,h,j=c.LayoutManager.prototype,l=d.pick(a,b);d.defaults(a,{views:{},__manager__:{},_removeViews:k._removeViews,_removeView:k._removeView},k.prototype),e=a.options=d.defaults(e||{},a.options,j.options),h=d.pick(e,i.call(["events"],d.values(e.events))),d.extend(a,h),(l.render===k.prototype.render||l.render===c.View.prototype.render)&&delete l.render,d.extend(e,l),a._remove=c.View.prototype.remove,a._render=function(a,b){var c=this,d=c.__manager__,e=b.beforeRender;return d.hasRendered&&this._removeViews(),e&&e.call(this,this),this.trigger("beforeRender",this),a(this,b).render()},a.render=k.prototype.render,a.remove!==j.remove&&(a._remove=a.remove,a.remove=j.remove),f=e.views||a.views,d.keys(f).length&&(g=f,a.views={},a.setViews(g)),a.options.template?a.options.template=e.template:a.template&&(e.template=a.template,delete a.template)}}});c.Layout=c.LayoutView=c.LayoutManager=k,k.VERSION="0.7.1",c.View.prototype._configure=function(){var a=f.apply(this,arguments);return this.manage&&k.setupView(this),a},k.prototype.options={prefix:"",deferred:function(){return e.Deferred()},fetch:function(a){return d.template(e(a).html())},partial:function(a,b,c,d){var f=b?e(a).find(b):e(a);this[d?"append":"html"](f,c)},html:function(a,b){e(a).html(b)},append:function(a,b){e(a).append(b)},when:function(a){return e.when.apply(null,a)},render:function(a,b){return a(b)},contains:function(a,b){return e.contains(a,b)}},b=d.keys(k.prototype.options)})(this);